
#day + year * months per year (12) * days per month (30) + offset % 32
#(day + (year * months * days) + offset) % 32
#(day + (year * months * days)) % offset -> both on 32 day orbit makes some combinations impossible
#offset = 3 for masser, -1 for secunda
# var:phase_[moon] = flag:[phase] is trigger


lunar_cycle_phase_masser = {
	if = {
		limit = { global_var:lunarphase_masser <= 6 }
		set_global_variable = { name = phase_masser value = flag:new }
	}
	else_if = {
		limit = { global_var:lunarphase_masser <= 12 }
		set_global_variable = { name = phase_masser value = flag:waxing }
	}
	else_if = {
		limit = { global_var:lunarphase_masser <= 19 }
		set_global_variable = { name = phase_masser value = flag:full }
	}
	else_if = {
		limit = { global_var:lunarphase_masser <= 25 }
		set_global_variable = { name = phase_masser value = flag:waning }
	}
}

lunar_cycle_phase_secunda = {
	if = {
		limit = { global_var:lunarphase_secunda <= 8 }
		set_global_variable = { name = phase_secunda value = flag:new }
	}
	else_if = {
		limit = { global_var:lunarphase_secunda <= 16 }
		set_global_variable = { name = phase_secunda value = flag:waxing }
	}
	else_if = {
		limit = { global_var:lunarphase_secunda <= 25 }
		set_global_variable = { name = phase_secunda value = flag:full }
	}
	else_if = {
		limit = { global_var:lunarphase_secunda <= 33 }
		set_global_variable = { name = phase_secunda value = flag:waning }
	}
}

lunar_cycle_start = {
	faith:imperial_cult = { #for some reason current_month requires a scope
		set_global_variable = {
			name = lunarphase_masser
			value = {
				add = lunar_cycle_start
				modulo = 24
			}
		}
		set_global_variable = {
			name = lunarphase_secunda
			value = {
				add = lunar_cycle_start
				modulo = 32
			}
		}
	}
	lunar_cycle_phase_masser = yes
	lunar_cycle_phase_secunda = yes
	trigger_event = {
		on_action = lunar_cycle_masser
		#days = 3
	}
	trigger_event = {
		on_action = lunar_cycle_secunda
		#days = 4
	}
	trigger_event = {
		on_action = stellar_cycle_serpent
		days = serpent_cycle_days
	}
}

lunar_cycle_masser_effect = {
	if = {
		limit = {
			OR = {
				global_var:lunarphase_masser = 0
				global_var:lunarphase_masser = 13
			}
		}
		change_global_variable = { name = lunarphase_masser	add = 4 }
		change_global_variable = { name = lunarphase_masser modulo = 26 }
		lunar_cycle_phase_masser = yes
		trigger_event = {
			on_action = lunar_cycle_masser
			days = 4
		}
	}
	else = {
		change_global_variable = { name = lunarphase_masser	add = 3 }
		change_global_variable = { name = lunarphase_masser modulo = 26 }
		lunar_cycle_phase_masser = yes
		trigger_event = {
			on_action = lunar_cycle_masser
			days = 3
		}
	}
}

lunar_cycle_secunda_effect = {
	if = {
		limit = {
			OR = {
				global_var:lunarphase_secunda = 0
				global_var:lunarphase_secunda = 17
			}
		}
		change_global_variable = { name = lunarphase_secunda add = 5 }
		change_global_variable = { name = lunarphase_secunda modulo = 34 }
		lunar_cycle_phase_secunda = yes
		trigger_event = {
			on_action = lunar_cycle_secunda
			days = 5
		}
	}
	else = {
		change_global_variable = { name = lunarphase_secunda add = 4 }
		change_global_variable = { name = lunarphase_secunda modulo = 34 }
		lunar_cycle_phase_secunda = yes
		trigger_event = {
			on_action = lunar_cycle_secunda
			days = 4
		}
	}
}

stellar_cycle_serpent_effect = {
	set_global_variable = { name = serpent_active value = yes days = serpent_active_days }
	trigger_event = {
		on_action = stellar_cycle_serpent
		days = serpent_cycle_days
	}
}