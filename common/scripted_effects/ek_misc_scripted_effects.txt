# Effect run when attempting to become an Occultist as a Witch
witch_become_occultist_effect = {
	remove_trait = witch
	add_trait = occultist
	
	add_piety_level = 1
}

startup_culture_effect = {
	save_culture_in_global_list = { CULTURE = culture:$CULTURE$ }
	culture_key_setup = { CULTURE = $CULTURE$ }
}

culture_key_setup = {
    culture:$CULTURE$ = {
        set_variable = { name = culture_key value = flag:$CULTURE$_ }
    }
}

### Destroy the Empire of Cyrodiil and create the k_heartlands
interregnum_shatter_cyrodiil = {
	### We create the vassal in the Imperial Isles (Imperial Commune)
	create_character = {
		location = title:c_imperial_city.title_province
		template = new_commander_character ### EK TODO: Not that (lol)
		faith = faith:imperial_cult
		culture = culture:heartlander
		save_scope_as = title_recipient
		gender_female_chance = {
			if = {
				limit = { scope:the_faith = { has_doctrine = doctrine_gender_male_dominated } }
				add = 0
			}
			else_if = {
				limit = { scope:the_faith = { has_doctrine = doctrine_gender_female_dominated } }
				add = 100
			}
			else = {
				add = 50
			}
		}
	}
	scope:title_recipient = { ek_character_setup_effect = yes }
	
	# We give them everything we own in k_heartlands (they usurp c_imperial_city if needed)
	title:k_heartlands = { add_to_list = titles_to_give }
	title:d_imperial_isle = { add_to_list = titles_to_give }
	title:c_imperial_city.title_province = { add_to_list = titles_to_give }
	every_held_title = {
		limit = { target_is_de_jure_liege_or_above = title:k_heartlands }
		add_to_list = titles_to_give
	}
	
	every_vassal = {
		limit = { capital_province = { kingdom = title:k_heartlands } }
		add_to_list = vassals_to_give
	}
	
	create_title_and_vassal_change = {
		type = independency
		save_scope_as = change
		add_claim_on_loss = no
	}
	
	every_in_list = {
		list = titles_to_give
		change_title_holder = {
			holder = scope:title_recipient
			change = scope:change
			take_baronies = yes
		}
	}
	
	every_in_list = {
		list = vassals_to_give
		change_liege = {
			liege = scope:title_recipient
			change = scope:change
		}
	}
	
	resolve_title_and_vassal_change = scope:change
	
	# Then they become independent
	create_title_and_vassal_change = {
		type = independency
		save_scope_as = change
		add_claim_on_loss = yes
	}
	scope:title_recipient = {
		becomes_independent = {
			change = scope:change
		}
	}

	resolve_title_and_vassal_change = scope:change
	
	
	## Now we destroy some stuff
	destroy_title = title:e_cyrodiil
	
	primary_title = { save_scope_as = primary_title }
	
	### Vassals become independent
	every_vassal = {
		limit = { NOT = { this.primary_title = { target_is_de_jure_liege_or_above = scope:primary_title } } }
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = yes
		}
		becomes_independent = {
			change = scope:change
		}

		resolve_title_and_vassal_change = scope:change
	}
	
	### Any county that isn't de Jure under our primary title becomes independent
	every_held_title = {
		limit = {
			NOT = { this = scope:primary_title }
			NOT = { target_is_de_jure_liege_or_above = scope:primary_title }
		}
		add_to_list = titles_to_make_independent
	}
	
	every_in_list = {
		list = titles_to_make_independent
		save_scope_as = current_title
		
		create_character = {
			location = scope:current_title.location
			template = new_commander_character ### EK TODO: Not that (lol)
			faith = scope:current_title.faith
			culture = scope:current_title.culture
			save_scope_as = title_recipient
			gender_female_chance = {
				if = {
					limit = { scope:the_faith = { has_doctrine = doctrine_gender_male_dominated } }
					add = 0
				}
				else_if = {
					limit = { scope:the_faith = { has_doctrine = doctrine_gender_female_dominated } }
					add = 100
				}
				else = {
					add = 50
				}
			}
		}
		scope:title_recipient = { ek_character_setup_effect = yes }
		
		# We give them the title
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}

		change_title_holder = {
			holder = scope:title_recipient
			change = scope:change
			take_baronies = yes
		}
		
		# And we make them independent
		scope:title_recipient = {
			becomes_independent = {
				change = scope:change
			}
		}
		
		resolve_title_and_vassal_change = scope:change
	}
	
	custom_tooltip = imperial_commune_creation_tooltip
	custom_tooltip = rest_cyrodiil_indepndent_tooltip
	custom_tooltip = interregnum_starts_tooltip
}

### To easily apply the effects of the Plunderer perks
calculate_bonus_resources_from_loot = {
	### EK EDIT: Grand Raider - Loot * 1.25
	if = {
		limit = { $RAIDER$ = { has_perk = grand_raider_perk } }
		
		change_variable = {
			name = raid_loot
			multiply = 1.25
		}
	}
	
	### EK EDIT: Loot & Prisoners - Loot / 5
	set_variable = {
		name = bonus_dev
		value = {
			value = var:raid_loot
			divide = 5
		}
	}
	
	### EK EDIT: Raider blood - Loot / 10
	set_variable = {
		name = bonus_renown
		value = {
			value = var:raid_loot
			divide = 10
		}
	}
}

### ! Requires you to use calculate_bonus_resources_from_loot at some point before
get_resources_from_loot = {
	### EK EDIT: Grand Raider - Loot * 1.25
	if = {
		limit = { $RAIDER$ = { has_perk = grand_raider_perk } }
		
		change_variable = {
			name = $LOOT$
			multiply = 1.25
		}
	}
	
	### EK EDIT: Loot & Prisoners - Loot / 5
	set_variable = {
		name = bonus_dev
		value = {
			value = $LOOT$
			divide = 5
		}
	}
	
	### EK EDIT: Raider blood - Loot / 10
	set_variable = {
		name = bonus_renown
		value = {
			value = $LOOT$
			divide = 10
		}
	}
	
	hidden_effect = { add_prestige = $LOOT$ }

	### EK EDIT: Gold is added differently, so we add the smol bonus here directly
	set_variable = {
		name = bonus_resources_gained
		value = {
			value = $LOOT$
			divide = 4
		}
	}
	hidden_effect = { add_gold = var:bonus_resources_gained }
	### EK EDIT: Sacred Raids - Give piety too
	if = { 
		limit = { has_perk = sacred_raids_perk }
		hidden_effect = { add_piety = $LOOT$ }
	}
	### EK EDIT: Raider Blood - Give renown too
	if = {
		limit = { has_perk = raider_blood_perk exists = $RAIDER$.dynasty }
		hidden_effect = { $RAIDER$.dynasty = { add_dynasty_prestige = $RAIDER$.var:bonus_renown } }
	}
}

### Spends the development progress stored in the variable in your counties, giving it in priority to the counties closer to growing
spend_dev_progress_own_counties = {
	set_variable = {
		name = loc_dev_points
		value = $DEV_POINTS$
	}
	
	while = {
		limit = { $DEV_POINTS$ > 0 }
		
		save_scope_value_as = {
			name = dev_points_left
			value = var:loc_dev_points
		}
		
		ordered_county = {
			limit = { this.holder = $OWNER$ }
			order_by = development_towards_level_increase
			
			save_scope_as = checked_county
			
			### We check how much dev points would have to be given for the county to get an additional dev 
			set_variable = {
				name = dev_needed
				value = 100
			}
			
			change_variable = {
				name = dev_needed
				subtract = scope:checked_county.development_towards_level_increase
			}
			
			save_scope_value_as = {
				name = dev_needed
				value = var:dev_needed
			}
			
			### Can we give that, or will the county have the settle with less?
			if = {
				limit = { scope:dev_points_left = { compare_value >= scope:dev_needed } }
				save_scope_value_as = {
					name = dev_given
					value = scope:dev_needed
				}
			}
			
			else = {
				save_scope_value_as = {
					name = dev_given
					value = scope:dev_points_left
				}
			}
			
			### Now that we know how much dev the county will get, give it
			change_development_progress = scope:dev_given
		}
		
		### And since we used some development, we subtract that value from the available dev points
		change_variable = {
			name = loc_dev_points
			subtract = scope:dev_given
		}
		clear_saved_scope = scope:dev_points_left
		clear_saved_scope = scope:dev_needed
	}
}