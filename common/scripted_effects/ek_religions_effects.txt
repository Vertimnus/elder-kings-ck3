### Scripted effects tied to religions & faiths
# Stuff scaling with stress level
update_religions_stress = {
	if = {
		limit = {
			OR = {
				# Your faith has a stress related tenet
				faith = { has_doctrine_parameter = stress_gives_piety_active }
				# You have a stress related modifier
				has_character_modifier = stress_gives_piety_stress_1
				has_character_modifier = stress_gives_piety_stress_2
				has_character_modifier = stress_gives_piety_stress_3
			}
		}
		
		# Remove the modifiers
		remove_character_modifier = stress_gives_piety_stress_1
		remove_character_modifier = stress_gives_piety_stress_2
		remove_character_modifier = stress_gives_piety_stress_3
		
		# Add the ones you need
		if = {
			limit = { faith = { has_doctrine_parameter = stress_gives_piety_active } }
			if = {
				limit = { stress_level >= 3 }
				add_character_modifier = stress_gives_piety_stress_3
			}
			else_if = {
				limit = { stress_level >= 2 }
				add_character_modifier = stress_gives_piety_stress_2
			}
			else_if = {
				limit = { stress_level >= 1 }
				add_character_modifier = stress_gives_piety_stress_1
			}
		}
	}
}

# Stuff scaling with devotion (piety_level)
clear_religions_piety_level_effect = {
	remove_character_modifier = $MODIFIER$_0
	remove_character_modifier = $MODIFIER$_1
	remove_character_modifier = $MODIFIER$_2
	remove_character_modifier = $MODIFIER$_3
	remove_character_modifier = $MODIFIER$_4
	remove_character_modifier = $MODIFIER$_5
}

update_religions_piety_level_effect = {
	clear_religions_piety_level_effect = { MODIFIER = $MODIFIER$ }
	
	if = {
		limit = { faith = { has_doctrine_parameter = $MODIFIER$ } }
		if = {
			limit = { piety_level >= 5 }
			add_character_modifier = $MODIFIER$_5
		}
		else_if = {
			limit = { piety_level >= 4 }
			add_character_modifier = $MODIFIER$_4
		}
		else_if = {
			limit = { piety_level >= 3 }
			add_character_modifier = $MODIFIER$_3
		}
		else_if = {
			limit = { piety_level >= 2 }
			add_character_modifier = $MODIFIER$_2
		}
		else_if = {
			limit = { piety_level >= 1 }
			#add_character_modifier = $MODIFIER$_1
		}
		else_if = {
			limit = { piety_level >= 0 }
			add_character_modifier = $MODIFIER$_0
		}
	}
}

### USE IT ONLY IF YOU ALREADY KNOW THE FAITH SUPPORTS THESE MODIFIERS
# If in doubt, use update_religions_piety_level_effect
unsafe_update_religions_piety_level_effect = {
	clear_religions_piety_level_effect = { MODIFIER = $MODIFIER$ }
	
	if = {
		limit = { piety_level >= 5 }
		add_character_modifier = $MODIFIER$_5
	}
	else_if = {
		limit = { piety_level >= 4 }
		add_character_modifier = $MODIFIER$_4
	}
	else_if = {
		limit = { piety_level >= 3 }
		add_character_modifier = $MODIFIER$_3
	}
	else_if = {
		limit = { piety_level >= 2 }
		add_character_modifier = $MODIFIER$_2
	}
	else_if = {
		limit = { piety_level >= 1 }
		#add_character_modifier = $MODIFIER$_1
	}
	else_if = {
		limit = { piety_level >= 0 }
		add_character_modifier = $MODIFIER$_0
	}
}

update_religions_piety_level = {
	### POPULAR OPINION WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_popular_opinion }
				# You have a devotion related modifier
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_popular_opinion }
			}
		}
		
		update_religions_piety_level_effect = { MODIFIER = devotion_gives_popular_opinion }
	}
	
	### CALAVRY EFFECTIVENESS WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_cavalry_effectiveness }
				# You have a devotion related modifier
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_cavalry_effectiveness }
			}
		}
		
		update_religions_piety_level_effect = { MODIFIER = devotion_gives_cavalry_effectiveness }
	}
	
	### DEVELOPMENT GROWTH WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_development_progress }
				# You have a devotion related modifier
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_development_progress }
			}
		}
		
		update_religions_piety_level_effect = { MODIFIER = devotion_gives_development_progress }
	}
	
	### LIFESTYLE EXPERIENCE WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_lifestyle_experience }
				# You have a devotion related modifier
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_lifestyle_experience }
			}
		}
		
		update_religions_piety_level_effect = { MODIFIER = devotion_gives_lifestyle_experience }
	}
	
	### CONTROL GROWTH WITH WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_control_growth }
				# You have a devotion related modifier
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_control_growth }
			}
		}
		
		update_religions_piety_level_effect = { MODIFIER = devotion_gives_control_growth }
	}
	
	### STAR SIGN POWER WITH DEVOTION
	if = {
		limit = {
			OR = {
				# Your faith has a devotion related tenet
				faith = { has_doctrine_parameter = devotion_gives_star_sign_power }
				# You have a devotion related modifier
				### Twelve star signs
				# Ritual
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_ritual }
				# Lover
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_lover }
				# Lord
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_lord }
				# Mage
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_mage }
				# Shadow
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_shadow }
				# Steed
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_steed }
				# Apprentice
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_apprentice }
				# Warrior
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_warrior }
				# Lady
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_lady }
				# Tower
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_tower }
				# Atronach
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_atronach }
				# Thief
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_thief }
				# Serpent
				has_character_modifier_scaling_devotion = { MODIFIER = devotion_gives_star_sign_power_serpent }
			}
		}
		
		if = {
			limit = { has_trait = sign_ritual }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_ritual }
		}
		else_if = {
			limit = { has_trait = sign_lover }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_lover }
		}
		else_if = {
			limit = { has_trait = sign_lord }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_lord }
		}
		else_if = {
			limit = { has_trait = sign_mage }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_mage }
		}
		else_if = {
			limit = { has_trait = sign_shadow }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_shadow }
		}
		else_if = {
			limit = { has_trait = sign_steed }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_steed }
		}
		else_if = {
			limit = { has_trait = sign_apprentice }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_apprentice }
		}
		else_if = {
			limit = { has_trait = sign_warrior }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_warrior }
		}
		else_if = {
			limit = { has_trait = sign_lady }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_lady }
		}
		else_if = {
			limit = { has_trait = sign_tower }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_tower }
		}
		else_if = {
			limit = { has_trait = sign_atronach }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_atronach }
		}
		else_if = {
			limit = { has_trait = sign_thief }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_thief }
		}
		else_if = {
			limit = { has_trait = sign_serpent }
			unsafe_update_religions_piety_level_effect = { MODIFIER = devotion_gives_star_sign_power_serpent }
		}
	}
}

### FAITH'S VIEW ON THE DAEDRIC PRINCES
faith_give_view_daedric_prince = {
	if = {
		limit = { has_doctrine = doctrine_hidden_daedra_allowed }
		if = {
			limit = {
				NOR = {
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_pantheon
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_allowed
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_shunned
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_criminal
				}
			}
			add_doctrine = doctrine_$DAEDRIC_PRINCE$_allowed
		}
	}
	else_if = {
		limit = { has_doctrine = doctrine_hidden_daedra_shunned }
		if = {
			limit = {
				NOR = {
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_pantheon
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_allowed
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_shunned
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_criminal
				}
			}
			add_doctrine = doctrine_$DAEDRIC_PRINCE$_shunned
		}
	}
	else_if = {
		limit = { has_doctrine = doctrine_hidden_daedra_criminal }
		if = {
			limit = {
				NOR = {
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_pantheon
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_allowed
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_shunned
					has_doctrine = doctrine_$DAEDRIC_PRINCE$_criminal
				}
			}
			add_doctrine = doctrine_$DAEDRIC_PRINCE$_criminal
		}
	}
}

faith_give_view_daedric_princes = {
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = azura }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = boethiah }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = clavicus }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = hermaeus }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = hircine }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = malacath }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = mehrunes }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = mephala }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = meridia }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = molag }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = namira }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = nocturnal }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = peryite }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = sanguine }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = sheogorath }
	faith_give_view_daedric_prince = { DAEDRIC_PRINCE = vaermina }
	
	# Remove the doctrines
	if = {
		limit = { has_doctrine = doctrine_hidden_daedra_allowed }
		remove_doctrine = doctrine_hidden_daedra_allowed
	}
	else_if = {
		limit = { has_doctrine = doctrine_hidden_daedra_shunned }
		remove_doctrine = doctrine_hidden_daedra_shunned
	}
	else_if = {
		limit = { has_doctrine = doctrine_hidden_daedra_criminal }
		remove_doctrine = doctrine_hidden_daedra_criminal
	}
}

faith_give_proper_cultural_identity_doctrine = {
	if = {
		limit = { has_doctrine = doctrine_cultural_identity_cg_creating_faith }
		root.culture.culture_group = { save_scope_as = culture_faith }
		set_variable = { name = associated_culture_group value = scope:culture_faith }
		remove_doctrine = doctrine_cultural_identity_cg_creating_faith
		add_doctrine = doctrine_cultural_identity_cg
	}
	else_if = {
		limit = { has_doctrine = doctrine_cultural_identity_cg_exclusive_creating_faith }
		root.culture.culture_group = { save_scope_as = culture_faith }
		set_variable = { name = associated_culture_group value = scope:culture_faith }
		remove_doctrine = doctrine_cultural_identity_cg_exclusive_creating_faith
		add_doctrine = doctrine_cultural_identity_cg_exclusive
	}
	else_if = {
		limit = { has_doctrine = doctrine_cultural_identity_culture_creating_faith }
		root.culture = { save_scope_as = culture_faith }
		set_variable = { name = associated_culture value = scope:culture_faith }
		remove_doctrine = doctrine_cultural_identity_culture_creating_faith
		add_doctrine = doctrine_cultural_identity_culture
	}
	else_if = {
		limit = { has_doctrine = doctrine_cultural_identity_culture_exclusive_creating_faith }
		root.culture = { save_scope_as = culture_faith }
		set_variable = { name = associated_culture value = scope:culture_faith }
		remove_doctrine = doctrine_cultural_identity_culture_exclusive_creating_faith
		add_doctrine = doctrine_cultural_identity_culture_exclusive
	}
}

### FERVOR EQUILIBRIUM
faith_update_fervor_equilibrium = {
	save_scope_as = current_faith
	
	##### V1
	# ### FERVOR EQUILIBRIUM COMPUTATION
	# ## Base
	# set_variable = {
		# name = fervor_equilibrium
		# value = 100
	# }
	
	# ## Every two counties subtract one fervor_equilibrium. 0 county = 100 fervor ; 100 counties = 50 fevor ; 200 counties = 0 fervor
	# # How should it impact our equilibrium
	# set_variable = {
		# name = half_num_county_followers
		# value = num_county_followers	
	# }
	# change_variable = {
		# name = half_num_county_followers
		# divide = 2
	# }
	# # Should we increase/decrease the equilibrium penality?
	# if = {
		# limit = { has_doctrine = doctrine_pluralism_pluralistic }
		# change_variable = {
			# name = half_num_county_followers
			# multiply = 0.85
		# }
	# }
	# # Apply it
	# change_variable = {
		# name = fervor_equilibrium
		# subtract = var:half_num_county_followers
	# }
	
	##### V2
	### FERVOR EQUILIBRIUM COMPUTATION
	## Base
	set_variable = {
		name = fervor_equilibrium
		value = 50
	}
	
	## How many temples compared to our counties. High nb of temples = positive equilibrium impact
	if = {
		limit = { num_county_followers > 0 }
		
		# 0 = 0%fe; 0.5 = 10fe; 1 = 20%fe
		set_variable = {
			name = fe_impact_nb_temples
			value = 0
		}
		
		every_barony = {
			limit = {
				this.faith = scope:current_faith
				title_province = { has_holding_type = church_holding }
			}
			scope:current_faith = { change_variable = { name = fe_impact_nb_temples add = 1 } }
		}
		
		# We get the proportion of temples (most of the time between 0 and 1, might be a bit above 1)
		change_variable = {
			name = fe_impact_nb_temples
			divide = num_county_followers
		}
		
		# Multiply that by 20, so that the fervor impact is (mostly) between 0 and +20%
		change_variable = {
			name = fe_impact_nb_temples
			multiply = 20
		}
		
		## And finally we apply that to our fervor equilibrium
		change_variable = {
			name = fervor_equilibrium
			add = var:fe_impact_nb_temples
		}
	}
	
	## Head of Faith impact (if any)
	if = {
		limit = { NOT = { has_doctrine_parameter = no_head_of_faith } }
		if = {
			limit = { exists = this.religious_head }
			this.religious_head = { save_scope_as = hof }
			
			# Each sin/virtue of the HoF modifies the fervor equilibrium by -5/+5%
			if = {
				limit = { scope:hof = { num_sinful_traits > 0 } }
				
				set_variable = {
					name = fe_impact_sinful_traits_hof
					value = -5
				}
				change_variable = {
					name = fe_impact_sinful_traits_hof
					multiply = this.religious_head.num_sinful_traits
				}
				change_variable = {
					name = fervor_equilibrium
					add = var:fe_impact_sinful_traits_hof
				}
			}
			if = {
				limit = { scope:hof = { num_virtuous_traits > 0 } }
				
				set_variable = {
					name = fe_impact_virtuous_traits_hof
					value = 5
				}
				change_variable = {
					name = fe_impact_virtuous_traits_hof
					multiply = this.religious_head.num_virtuous_traits
				}
				change_variable = {
					name = fervor_equilibrium
					add = var:fe_impact_virtuous_traits_hof
				}
			}
		}
		else = {
			# If there is no HoF while you should have one, we assume it has 3 sins (so you should get one)
			set_variable = {
				name = fe_impact_hof_missing
				value = -15
			}
			change_variable = {
				name = fervor_equilibrium
				add = var:fe_impact_hof_missing
			}
		}
	}
	
	## Daedric cults
	# Once it's in the mod, the strength of the Daedra revered by its cult should impact the cult fervor (high fervor when the Prince is strong, low when the Prince is weak)
	
	## Doctrines & Tenets
	# Faiths with Ecclesiarchy get an equilibrium boost for each holy site
	if = {
		limit = { has_doctrine_parameter = holy_site_increase_fervor_equilibrium_active }
		set_variable = {
			name = fe_impact_ecclesiarchy_boost
			value = 5
		}
		change_variable = {
			name = fe_impact_ecclesiarchy_boost
			multiply = holy_sites_controlled
		}
		
		change_variable = {
			name = fervor_equilibrium
			add = var:fe_impact_ecclesiarchy_boost
		}
	}
	
	# The Leader of the Council of the Eight gets an equilibrium boost (5 per member)
	if = {
		limit = { has_doctrine = special_faith_group_council_of_the_eight_leader }
		set_variable = {
			name = fe_impact_leader_co8
			value = 0
		}
		every_religion_global = {
			every_faith = {
				limit = { has_doctrine = special_faith_group_council_of_the_eight_member }
				scope:current_faith = {
					change_variable = {
						name = fe_impact_leader_co8
						add = 5
					}
				}
			}
		}
		change_variable = {
			name = fervor_equilibrium
			add = var:fe_impact_leader_co8
		}
	}
	
	## Size penalty
	# Faiths with over 50 counties get a scaling FE penalty, based on the (currently disabled) fervor gain penalty gain due to size
	# fe = fe * 1/sqrt(max(49, faith_size)/49)
	# Only checks if nb counties > 49, so fe *= 1/sqrt(faith_size/49)
	if = {
		limit = { num_county_followers > 49 }
		set_local_variable = { name = param value = { value = num_county_followers } }
		get_sqrt = yes
		
		if = { # Some tenets and doctrines can reduce this size penalty
			limit = { has_doctrine_parameter = reduces_number_counties_fervor_equilibrium_penality_active }
			# We slightly lower sqrt(faith_size), so the penalty isn't as strong
			set_local_variable = {
				name = result
				value = {
					value = local_var:result
					multiply = 0.75
				}
			}
		}
		
		set_local_variable = { name = result value = { value = local_var:result divide = 7 } } # We divide by sqrt(7) here, as sqrt(faith_size/49) = sqrt(faith_size)/sqrt(49)
		
		set_variable = { # We get 1/sqrt(faith_size/49)
			name = fe_impact_faith_size
			value = {
				value = 1
				divide = local_var:result
			}
		}
		set_variable = { # That's our new Equilibrium
			name = fervor_equilibrium_new
			value = {
				value = var:fervor_equilibrium
				multiply = var:fe_impact_faith_size
			}
		}
		# set_variable = { # That's the difference
			# name = fe_impact_faith_size
			# value = {
				# value = var:fervor_equilibrium
				# subtract = var:fervor_equilibrium_new
			# }
		# }
		
		set_variable = { # We apply the new equilibrium
			name = fervor_equilibrium
			value = var:fervor_equilibrium_new
		}
	}
	
	## Aftermath (once most penalties and bonuses have been applied)
	# Each member of the Council of the Eight uses the average of their base fervor equilibrium and the leader's
	if = {
		limit = { has_doctrine = special_faith_group_council_of_the_eight_member }
		set_variable = {
			name = fe_impact_leader_co8_member
			value = global_var:leader_council_eight.var:fervor_equilibrium
		}
		change_variable = {
			name = fe_impact_leader_co8_member
			subtract = var:fervor_equilibrium
		}
		change_variable = {
			name = fe_impact_leader_co8_member
			divide = 2
		}
		
		change_variable = {
			name = fervor_equilibrium
			add = var:fe_impact_leader_co8_member
		}
	}
	
	## Finally, make sure it's between bounds that make sense
	if = {
		limit = { var:fervor_equilibrium = { compare_value < 0 } }
		set_variable = {
			name = fervor_equilibrium
			value = 0
		}
	}
	else_if = {
		limit = { var:fervor_equilibrium = { compare_value > 100 } }
		set_variable = {
			name = fervor_equilibrium
			value = 100
		}
	}
	
	## If we're the leader of the Council of the Eight, update the members' fervor equilibrium
	if = {
		limit = { has_doctrine = special_faith_group_council_of_the_eight_leader }
		every_religion_global = {
			every_faith = {
				limit = { has_doctrine = special_faith_group_council_of_the_eight_member }
				faith_update_fervor_equilibrium = yes
			}
		}
	}
}
